# Breakdown 初期化時のコピー処理仕様書

## 1. 概要

Breakdownの初期化処理において、プロンプトとスキーマのテンプレートファイルを適切なディレクトリにコピーする機能の仕様を定義する。この機能は、JSR経由でのインストール時にも正常に動作する必要があり、ユーザーのカスタマイズ性を確保しながら、システムの標準テンプレートを提供する。実装には、ファサードパターンによる初期化プロセスの簡素化、ストラテジーパターンによる展開方法の柔軟性、ビルダーパターンによる展開プロセスの制御を採用する。

## 2. アーキテクチャ設計

### 2.1 コアコンポーネント

#### Workspace（ファサード）
初期化処理の中心となるクラス。複雑な初期化プロセスを単一のインターフェースで提供し、内部実装の詳細を隠蔽する。`initialize()`メソッドを通じて、ディレクトリ構造の作成とテンプレートの展開を実行する。`WorkspaceStructure`インターフェースを通じてディレクトリ操作を行い、`WorkspaceConfigManager`を使用して設定を管理する。

#### TemplateManager（ストラテジー）
テンプレートの管理を担当するクラス。異なる展開戦略を切り替え可能な形で実装し、テンプレートの読み込み、展開、更新を制御する。`initializeTemplates()`メソッドでテンプレートの初期展開を行い、`getTemplate()`メソッドでテンプレートの取得を提供する。`WorkspacePathResolver`を使用してパス解決を行う。

#### TemplateExpander（ビルダー）
テンプレートの展開処理を担当するクラス。複雑な展開プロセスを段階的に構築し、ファイルシステムへの書き込みと上書きルールの適用を管理する。`expandTemplates()`メソッドで実際のファイル展開を行い、`isInExcludedDir()`と`shouldSkipFile()`メソッドで展開ルールを適用する。

### 2.2 補助コンポーネント

#### TemplateFactory（ファクトリ）
テンプレートの生成を担当するクラス。テンプレートの種類に応じた適切な生成方法を提供し、拡張性とテスト容易性を確保する。`PromptVariablesFactory`と連携して、テンプレート変数を管理する。

#### TemplateValidator（プロキシ）
テンプレートの検証とアクセス制御を担当するクラス。テンプレートへのアクセスを制御し、不正なテンプレートが展開されないようにする。`WorkspaceConfigManager`を使用して設定の検証を行う。

## 3. 処理フロー

### 3.1 初期化プロセス

1. ワークスペースの初期化（ファサード）
   - `WorkspaceStructure.ensureDirectories()`によるディレクトリ構造の作成
   - `WorkspaceConfigManager`による設定ファイル（app.yml）の生成
   - テンプレート展開の準備

2. テンプレートの展開（ストラテジー）
   - `WorkspacePathResolver`によるパス解決
   - `PromptVariablesFactory`による変数の生成
   - ファイル展開の実行

3. 展開ルールの適用（ビルダー）
   - ユーザー設定ディレクトリの保護
   - 既存ファイルの上書き制御
   - エラーハンドリング

### 3.2 テンプレート管理プロセス

1. テンプレートの取得（ストラテジー）
   - `WorkspacePathResolver`によるパス解決
   - カスタムテンプレートの優先
   - デフォルトテンプレートのフォールバック

2. テンプレートの更新（ファクトリ）
   - システムテンプレートの更新
   - カスタムテンプレートの保護
   - 更新履歴の管理

## 4. 実装上の注意点

### 4.1 パッケージング

JSR経由でのインストール時にテンプレートファイルが利用可能であることを保証するため、テンプレートはTypeScriptファイルに埋め込む必要がある。ビルド時にMarkdownファイルをTypeScriptに変換し、実行時に必要に応じてファイルシステムに展開する。この実装には、ファクトリパターンとビルダーパターンを組み合わせて使用する。

### 4.2 カスタマイズ性

ユーザーが指定したベースディレクトリ内のファイルは、システムの更新時にも上書きされないように保護する必要がある。また、カスタムテンプレートはシステムテンプレートよりも優先的に使用される。この実装には、ストラテジーパターンとプロキシパターンを組み合わせて使用する。

### 4.3 エラーハンドリング

テンプレートの展開時に発生する可能性のあるエラーを適切に処理し、ユーザーに分かりやすいエラーメッセージを提供する。また、テンプレートの検証を行い、不正なテンプレートが展開されないようにする。この実装には、プロキシパターンとビルダーパターンを組み合わせて使用する。

## 5. テスト要件

### 5.1 単体テスト

- テンプレートの読み込みと展開（ストラテジー）
- 上書きルールの適用（ビルダー）
- エラーハンドリング（プロキシ）
- カスタムテンプレートの優先（ストラテジー）

### 5.2 統合テスト

- 初期化プロセスの全体（ファサード）
- パッケージングと展開（ビルダー）
- ユーザー設定の反映（ストラテジー）
- エラー時の動作（プロキシ） 