# Breakdown テスト仕様書

## テスト方針

### 基本方針
- 階層的なテスト戦略を採用し、基本機能から段階的にテストを実施
- 下位層のテストが失敗した場合、上位層のテストは実行しない
- 各階層でのテスト成功を次の階層のテスト実行条件とする
- エラーケースは各階層で重要度の高いものを優先的にテスト

### テスト実行の考え方
1. 階層別の独立実行
   - 各階層は `deno test {階層名}` で独立して実行可能
   - 例：`deno test "0. 基盤テスト"` で基盤機能の健全性を確認
   - 各階層のテスト成功は、その機能が正常に動作する保証となる

2. テスト階層の意図
   - 0番台（基盤テスト）: アプリケーションの実行基盤が正常に機能することを保証
   - 1番台（コア機能）: 各機能が独立して正しく動作することを保証
   - 2番台（連携テスト）: 機能間の相互作用が正しく行われることを保証
   - 3番台（シナリオ）: エンドユーザーの利用シナリオが正しく動作することを保証

3. 段階的な品質確保
   - 下位層から順にテストを実行し、基盤から積み上げて品質を確保
   - 各層でのテスト成功は、その層に依存する上位層のテストが意味を持つことを保証
   - テスト失敗時は、その層の問題を解決してから上位層のテストを実行

### 依存関係に基づくテスト戦略
1. 前提条件の検証
   - 設定ファイルの読み込みは全ての機能の前提となるため最優先で検証
   - 基本的なログ出力機能は、デバッグやエラー追跡に不可欠なため早期に検証
   - パラメータ処理は、全てのコマンド実行の入り口となるため優先的に検証

2. 機能の依存関係チェーン
   - 設定 → パラメータ処理 → プロンプト管理 → パス処理 の順で機能が連鎖
   - 各機能は前段の機能が正常に動作することを前提とする
   - エラーは依存関係に沿って伝播することを確認

3. 統合ポイントの特定
   - 複数の機能が交わる箇所を特定し、それらの連携を重点的に検証
   - 特に、設定とパラメータの組み合わせ、プロンプトとパス処理の連携を注視

## テスト手法
- Deno Test を使用し、依存関係を考慮したテストスイートを構築
- モック/スタブは依存関係の切り離しが必要な箇所のみに限定
- テストデータは依存関係チェーンを通して一貫性のある値を使用
- 環境変数による制御は、LOG_LEVEL等の基盤機能の制御のみに使用
- 各テストは可能な限り独立して実行可能にしつつ、依存関係も考慮

## テストディレクトリ構造
```
tests/
├── 0_foundation/           # 基盤テスト
│   ├── config_test.ts     # 設定基盤のテスト
│   └── logger_test.ts     # ロギング基盤のテスト
│
├── 1_core/                # コア機能テスト
│   ├── params_test.ts     # パラメータ処理のテスト
│   ├── prompt_test.ts     # プロンプト管理のテスト
│   └── path_test.ts       # パス処理のテスト
│
├── 2_integration/         # 連携テスト
│   ├── flow_test.ts       # 基本フロー連携のテスト
│   └── error_test.ts      # エラー伝播のテスト
│
├── 3_scenarios/           # シナリオテスト
│   ├── commands_test.ts   # 基本コマンドのテスト
│   ├── convert_test.ts    # 変換シナリオのテスト
│   └── analyze_test.ts    # 分析シナリオのテスト
│
├── fixtures/              # テスト用の固定データ
│   ├── config/           # 設定ファイルのサンプル
│   ├── prompts/          # プロンプトファイルのサンプル
│   └── projects/         # プロジェクトファイルのサンプル
│
└── helpers/              # テストヘルパー
    ├── setup.ts          # テスト環境のセットアップ
    └── assertions.ts     # カスタムアサーション
```

このディレクトリ構造により：
- 各階層のテストを独立して実行可能（例：`deno test tests/0_foundation/`）
- テストデータとヘルパー関数を共有可能
- テストの依存関係が物理的な構造として表現される

## テスト階層構造と実行順序

### 0. 基盤テスト（Foundation）
- アプリケーションの実行基盤となる機能のテスト
- 他の全てのテストの前提条件を検証
- この層のテストが失敗した場合、他のテストは実行不可

### 1. コア機能テスト（Core Features）
- 基盤テストの成功を前提とする機能テスト
- 各機能間の依存関係に従ってテストを実行
- 下位の機能から順次テストを実施

### 2. 連携テスト（Integration）
- コア機能間の相互作用を検証
- 依存関係チェーンに沿った機能連携の確認
- エラーの伝播経路の検証

### 3. シナリオテスト（Scenarios）
- 実際のユースケースに基づくテスト
- 全ての依存関係が満たされた状態での検証
- エンドユーザーの視点からの機能確認

## テスト項目一覧

### 0. 基盤テスト
#### 0.1 設定基盤テスト (BreakdownConfig)
- 設定ファイルの存在確認と読み込み
  - 必須設定ファイルの存在チェック
  - 基本的な設定値の読み込み
  - 設定値の型チェック
- 必須ディレクトリの検証
  - 作業ディレクトリの存在確認
  - プロンプトディレクトリの存在確認
  - スキーマディレクトリの存在確認

#### 0.2 ロギング基盤テスト (Logger)
- ログ出力の基本機能
  - ログレベルの初期設定
  - 基本的なログ出力
  - 環境変数によるログ制御

### 1. コア機能テスト
#### 1.1 パラメータ処理テスト (ParamsParser)
- 基本パラメータ処理
  - コマンドライン引数の基本解析
  - 必須パラメータの検証
  - オプションの基本処理
- 設定連携
  - 設定値に基づくパラメータ検証
  - パラメータと設定の整合性確認

#### 1.2 プロンプト管理テスト (PromptManager)
- プロンプトファイル処理
  - 設定に基づくファイル読み込み
  - パラメータに基づくプロンプト選択
  - 基本的な変数置換
- レイヤー処理
  - パラメータに基づくレイヤー選択
  - レイヤー間の関係性検証

#### 1.3 パス処理テスト
- 入力パス処理
  - 設定に基づくパス解決
  - パラメータに基づくパス生成
- 出力パス処理
  - 設定に基づく出力先決定
  - パラメータに基づく出力名生成

### 2. 連携テスト
#### 2.1 基本フロー連携
- 設定・パラメータ連携
  - 設定に基づくパラメータ処理
  - パラメータによる設定の参照
- プロンプト・パス連携
  - プロンプトに基づくパス生成
  - パスに基づくプロンプト選択

#### 2.2 エラー伝播検証
- 設定エラーの伝播
  - 設定エラー時のパラメータ処理
  - 設定エラー時のプロンプト処理
- パラメータエラーの伝播
  - パラメータエラー時のプロンプト処理
  - パラメータエラー時のパス処理

### 3. シナリオテスト
#### 3.1 基本コマンドシナリオ
- 初期化シナリオ
  - 設定・パラメータ・ディレクトリの連携
- ヘルプ/バージョン表示シナリオ
  - パラメータ・出力の連携

#### 3.2 変換シナリオ
- プロジェクト変換
  - 設定・パラメータ・プロンプト・パスの連携
  - project → issue の完全フロー
- イシュー変換
  - 設定・パラメータ・プロンプト・パスの連携
  - issue → task の完全フロー

#### 3.3 分析シナリオ
- 要約生成
  - 設定・パラメータ・プロンプト・パスの連携
  - 各レイヤーでの要約フロー
- 欠陥分析
  - 設定・パラメータ・プロンプト・パスの連携
  - 分析実行の完全フロー 