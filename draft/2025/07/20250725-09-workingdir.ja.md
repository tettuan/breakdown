# 緊急修正指示書 - WorkspaceとWorkingDirのパス解決問題の修正

## 実装方針

以下の実装を、ユースケースに基づく仕様を把握したうえで修正する。
(1)設定ファイル読み見込みPATH統一不足、(2)--uv-*のユーザー変数置換、(3)find bugsコマンドなど任意のパラメータを設定経由で許可する処理の不備、(4)STDINの代わりに --from オプションが {input_text}を置換してしまう問題。


作業着手前に、設計思想を理解する。
`Totality` について、必ず `docs/breakdown/generic_domain/system/overview/totality.ja.md` を参照すること。
ドメイン情報は、 `docs/breakdown/domain_core/domain_boundaries_flow.ja.md` および `docs/breakdown/domain_core/*` を必ず読むこと。
実装のAI複雑性制御は `docs/breakdown/domain_core/ai-complexity-control_compact.ja.md` の原則に従い、最小限の修正で最大の効果を得ること。

実装オプションの変数との関係は、用語集を参照すること。
`docs/breakdown/generic_domain/system/overview/glossary.ja.md`

テスト方針:
テストに関しては `docs/tests/testing.ja.md` を読むこと。

仕様:
他の`docs/breakdown/*`資料は、適宜実装ファイルを変更するタイミングで読むこと。

[TwoParams型システム](docs/breakdown/domain_core/two_params_types.ja.md)の設計に従い、DirectiveTypeとLayerTypeの組み合わせによるパス解決を正しく機能させる必要がある。


## チームの構成

あなたは指揮官であり上司である。
最初にチームを立ち上げて進める。

`instructions/team-head.ja.md` に詳細の記載がある。
チーム立ち上げの指示なので、必ず最初に読むこと。
各paneの存在を確認し、無ければ起動し、あればClaudeの起動を確認すること。全員を調べ、Claudeが起動していない部下に対し,Claude起動する。


## 実施内容

### 1. 前提理解
1. 資料を読んで、ドメイン設計と Totality を理解する。
2. 理解した結果や調査した結果を `tmp/<branch_name>/` 配下に作成する。

### 2. 作業開始
3. 「修正内容の詳細」を修正する
4. 以下のチェックコマンドを順次行い、成功か失敗かで次のステップを変える。
4-1. `deno check [DIR]` : 成功→6-2,失敗→7
4-2. `deno test [DIR]` : 成功→6-3,失敗→7
4-3. `deno lint [DIR]` : 成功→6-4,失敗→7
4-4. `deno fmt [DIR]`  : 成功→8,失敗→7
5. エラー修正作業をワーカープールに割り当て、修正後に6のステップを再確認させる
6. `deno task ci:dirty` を実行。エラー → 「2. 作業開始」を最初から実施


#### 修正内容の詳細

`````
# 書記官統合レポート - fix/working-dir-path-resolution

## 概要
全ワーカーとマネージャーからの報告を集約した最終統合レポートです。特に重大問題（変数置換、find bugs、パイプライン）に焦点を当てています。

## 報告状況
- 作成日時: 2025-07-25
- 収集状況: 最終報告完了

## 重大問題サマリー

### 1. 変数置換問題
- **状況**: 修正必要
- **影響範囲**: プロンプト生成処理全般
- **詳細**: 
  - `lib/cli/generators/two_params_prompt_generator_ddd.ts`内の変数置換処理でワーキングディレクトリパスの解決に問題
  - プロンプトテンプレート内の変数がBreakdownConfigから取得したworkingDirで正しく置換されない
  - 影響: プロンプト生成時に正しいファイルパスが参照されない

### 2. Find Bugs（パス解決エラー）
- **状況**: 調査・修正中
- **影響範囲**: ファイルパス解決機能
- **詳細**: 
  - `lib/factory/prompt_template_path_resolver_totality.ts`でのパス解決処理に問題
  - 相対パスと絶対パスの変換処理で不整合が発生
  - テストケースでの期待値と実際の動作にずれ

### 3. パイプライン問題
- **状況**: CI/CDパイプライン失敗
- **影響範囲**: 全体のデプロイメントプロセス
- **詳細**: 
  - `scripts/local_ci.sh`実行時に複数のテストが失敗
  - 主にE2Eテスト(`tests/4_cross_domain/e2e/two_params_result_e2e_test.ts`)で問題
  - ワーキングディレクトリパス解決の不具合が原因

## 根本原因分析

### 主要問題
1. **BreakdownConfigの初期化タイミング**
   - Configオブジェクトの生成時にworkingDirが正しく設定されていない
   - 環境変数やデフォルト値の優先順位に問題

2. **パス解決の一貫性欠如**
   - 相対パス・絶対パスの変換ロジックが複数箇所で異なる実装
   - path.resolve()とpath.join()の使い分けが不適切

3. **テストデータとの不整合**
   - テスト環境でのワーキングディレクトリ設定が本番環境と異なる
   - モックデータの設定が実際の動作と乖離

## 推奨される修正アプローチ

### 優先順位1: 変数置換処理の修正
1. `two_params_prompt_generator_ddd.ts`の`generatePrompt`メソッド内で、BreakdownConfigから取得するworkingDirの扱いを修正
2. プロンプトテンプレートへの変数注入時のパス解決を統一

### 優先順位2: パス解決ロジックの統一
1. `prompt_template_path_resolver_totality.ts`でのパス解決を一元化
2. 全ての場所でpath.resolve()を使用してabsolute pathに統一

### 優先順位3: テスト環境の整備
1. テスト実行時のワーキングディレクトリ設定を明確化
2. E2Eテストでの期待値を実際の動作に合わせて修正

## 次回アクション
1. 変数置換処理の修正実装
2. パス解決ロジックの統一化
3. テストケースの更新と再実行
4. CI/CDパイプラインの正常化確認

# STDIN入力と{input_text}置換の検証結果

## 検証内容
`{input_text}`プレースホルダーがSTDIN入力で正しく置換されるかを確認

## 検証結果

### テンプレート内容
```markdown
# Project Summary Analysis

## Project Overview

Based on the provided project information:

{input_text}

## Key Findings
...
```

### 実行結果

#### 1. STDINからの入力（パイプ）
```bash
echo "Test input data from STDIN" | breakdown summary project
```
**結果**: [NG] `{input_text}`が置換されず、そのまま出力される

#### 2. --fromオプションでの入力
```bash
breakdown summary project --from=test_input.md
```
**結果**: [OK] 正しく入力内容に置換される

### 出力例（--fromオプション使用時）
```markdown
# Project Summary Analysis

## Project Overview

Based on the provided project information:

# Test Project
This is a test project to check variable replacement.

## Key Findings
...
```

## 結論

- [OK] **--fromオプション**: `{input_text}`は正しく入力ファイルの内容に置換される
- [NG] **STDIN（パイプ）**: `{input_text}`が置換されず、文字列のまま残る

これは重要な発見です。STDINからの入力処理に問題があり、プレースホルダーの置換が機能していません。

## 影響
- 04_stdin_example.shは--fromオプションを使用しているため正常動作
- パイプを使った入力では変数置換が機能しない

## 推奨対応
- STDINからの入力時も`{input_text}`を正しく置換するよう修正が必要
- 現状では--fromオプションの使用を推奨
`````

#### 完了条件

1. working_dir設定が一元化された
2. ハードコーディングが亡くなった
3. PATH決定のテストが成功した
4. [実装のAI複雑性制御](`docs/breakdown/domain_core/ai-complexity-control_compact.ja.md`) の原則に従い、最小限のコード量で最大の効果を得ること。
5. `deno task ci:dirty` が完全に通過した: エラー0件達成


# タスクの進め方

- Git:
  - 現在のGitブランチで作業する
- サイクル: 仕様把握 → 調査 → 計画・設計 → 実行 → 記録・検証 → 学習 → 仕様把握へ戻る
- 作業分担: 作業内容をワーカープールマネージャーへ依頼し、ワーカーへの指示を行わせる。チームの常時フル稼働を目指す。

## 進捗更新

- 進捗させるべきタスクは `tmp/<branch_name>/tasks.md` に書き出し、完了マークをつけたりしながら進めてください。
- すべてが完了したら、`tmp/<branch_name>/completed.md` に完了したレポートを記録してください。


# 作業開始指示

まずチームを立ち上げます。
その後、初期タスク（仕様理解、実装調査）を早々にワーカープールマネージャーへ渡します。

続いて、仕様の理解を進め、実装方針に基づいてワーカープールの稼働を最大化します。
その後は、チーム全体のパフォーマンスが重要です。
常にワーカープールマネージャーと、その部下であるゴルーチンをフル稼働させてください。

今なにをすべきか（タスク分割や、状況整理、要件定義、実装、テスト）について、ワーカープールマネージャーが把握していることが重要です。ワーカープールマネージャーから、今やる詳細タスクへ分割し、部下ゴルーチンへ割り当てさせてください。

プロジェクトの成功を祈ります。開始してください。



