# プロジェクト: Breakdown全体のドメイン駆動設計と全域性（Totality）への移行と処理統一

実装方針:
現在の`lib/`配下の実装をドメイン駆動設計と全域性（Totality）による設計で、処理を統一する。重複実装を削除し、ドメイン領域の明確な理解に基づき、型安全性を強化して、骨格が通った芯の強いコード体系に統一する。

`Totality` について、必ず `docs/breakdown/generic_domain/system/overview/totality.ja.md` を参照すること。
ドメイン情報は、 `docs/breakdown/domain_core/two_params_types.ja.md.ja.md` および `docs/breakdown/domain_core/*` を必ず読むこと。

テスト方針:
テストに関しては `docs/tests/testing.ja.md` を読むこと。

仕様:
他の`docs/breakdown/*`資料は、適宜実装ファイルを変更するタイミングで読むこと。

## 実施内容


## 実施内容

1. 資料を読んで、ドメイン設計と Totality を理解する。
2. 理解した結果や調査した結果を `tmp/<branch_name>/` 配下に作成する。
2-1. `two_params_types.ja.md` について入念に理解する
3. 「修正対象」をリストとして扱い、順次処理する。
4. リストに基づき、`@deprecated` な処理は一掃(全面的削除)する。
5. 旧式の実装を削除し、重複処理を削除し、利用していない新方式を取り込む
5-1. 3で作業選択した型と同じ階層で、他のファイルを調べる
5-2. ファイル内に類似処理があれば、さらに詳しく読み込む
5-3. 既存の実装より適した実装があれば、既存実装を捨てて、新実装へ書き換える
5-4. メイン処理から処理を3-4回パターン別でトレースし、呼び出されることのないコードならば、ファイルごと削除する
6. 削除した実装のテストは、連動して削除する
7. 3で作成したリストの全てが完了するまで、再び4に戻り、実装修正を行う

**テストは実施せず、実装コード修正に集中する**

### 全ての「実施内容」が完了した後

1. 「ディレクトリ一覧」を１行ずつ選び、ディレクトリ内のファイルを順序よく調べる
2. 個々のファイルを開き、重複処理の存在をチェックする
3. 重複処理があったら `tmp/duplicated_files.md` へ書き出す
4. 重複処理の実装ファイルは削除する
5. 1の処理へ戻る

## 完了条件

1. 重複処理が削除された
2. `tmp/duplicated_files.md`が完成した


# タスクの進め方

- Git:
  - 現在のGitブランチで作業する
- サイクル: 仕様把握 → 調査 → 計画・設計 → 実行 → 記録・検証 → 学習 → 仕様把握へ戻る
- 作業分担: 作業内容をワーカープールマネージャーへ依頼し、ワーカーへの指示を行わせる。チームの常時フル稼働を目指す。

## チームの構成

あなたは指揮官であり上司である。
最初にチームを立ち上げて進める。

`instructions/team-head.ja.md` に詳細の記載がある。
チーム立ち上げの指示なので、必ず最初に読むこと。
各paneの存在を確認し、無ければ起動し、あればClaudeの起動を確認すること。全員を調べ、Claudeが起動していない部下に対し,Claude起動する。


## 進捗更新

- 進捗させるべきタスクは `tmp/<branch_name>/tasks.md` に書き出し、完了マークをつけたりしながら進めてください。
- すべてが完了したら、`tmp/<branch_name>/completed.md` に完了したレポートを記録してください。


## 修正対象
```
# Breakdown Application Structure - 2025-07-12
# 
# Main flow: main → runBreakdown → parameter parsing → prompt generation → stdout
# Goal: Output prompt template to stdout

application:
  entry_points:
    - name: mod.ts
      type: module_entry
      exports: 
        - runBreakdown
      delegates_to: cli/breakdown.ts
    
    - name: cli/breakdown.ts
      type: cli_entry
      main_function: runBreakdown
      flow:
        - config_detection
        - config_loading
        - parameter_parsing
        - parameter_routing
        - prompt_generation
        - stdout_output

  main_flow:
    # ステップ1: 設定プロファイル検出
    config_detection:
      - name: ConfigPrefixDetector
        initializer: extract()
        args: string[]
        return: string | undefined
        
      - name: ConfigProfileName
        initializer: create()
        args: string
        return: Result<ConfigProfileName, ConfigProfileNameError>
    
    # ステップ2: 設定読み込み
    config_loading:
      - name: loadBreakdownConfig
        args: ConfigProfileName
        return: BreakdownConfig
        package: "@tettuan/breakdownconfig"
    
    # ステップ3: パラメータ解析
    parameter_parsing:
      - name: ParamsParser
        initializer: new ParamsParser()
        args: BreakdownConfig
        return: ParamsParser
        package: "@tettuan/breakdownparams"
        
      - name: parseParameters
        args: string[]
        return: ParamsResult
        branches:
          - zero_params_flow
          - one_param_flow
          - two_params_flow
          - error_result

  # ゼロパラメータフロー（異常系として1階層で停止）
  zero_params_flow:
    - name: ZeroParamsHandler
      initializer: handle()
      args: ZeroParamsResult
      return: void
      outputs:
        - help_message
        - version_info
        - usage_info

  # 1パラメータフロー（異常系として1階層で停止）
  one_param_flow:
    - name: OneParamHandler
      initializer: handle()
      args: OneParamsResult, ConfigProfileName
      return: Result<void, OneParamHandlerError>
      commands:
        - init: workspace_initialization

  # 2パラメータフロー（正常系 - 骨格の中心）
  two_params_flow:
    # 階層1: オーケストレーション
    orchestration:
      - name: TwoParamsOrchestrator
        initializer: orchestrate()
        args: TwoParamsResult, ConfigProfileName
        return: Result<void, TwoParamsOrchestratorError>
        
    # 階層2: バリデーション
    validation:
      - name: TwoParamsValidator
        initializer: validate()
        args: TwoParamsResult
        return: Result<TwoParams, TwoParamsValidatorError>
        
      - name: TwoParams
        initializer: create()
        args: DirectiveType, LayerType
        return: Result<TwoParams, TwoParamsError>
        
    # 階層3: プロンプト生成パイプライン
    prompt_pipeline:
      stdin_processing:
        - name: TwoParamsStdinProcessor
          initializer: process()
          args: void
          return: Result<string, TwoParamsStdinProcessorError>
          
      variable_processing:
        - name: TwoParamsVariableProcessor
          initializer: process()
          args: Options, string
          return: Result<VariableProcessingResult, TwoParamsVariableProcessorError>
          
      prompt_generation:
        - name: TwoParamsPromptGenerator
          initializer: generate()
          args: TwoParams, VariableProcessingResult, ConfigProfileName
          return: Result<string, TwoParamsPromptGeneratorError>
          
        - name: PromptManagerAdapter
          initializer: generatePrompt()
          args: PromptPath, PromptVariables
          return: Result<string, PromptError>
          package: "@tettuan/breakdownprompt"
          
      output_processing:
        - name: TwoParamsOutputProcessor
          initializer: process()
          args: string
          return: Result<void, TwoParamsOutputProcessorError>

  # 型宣言（簡易な宣言構造）
  type_declarations:
    # Result型（基本パターン）
    result_types:
      - name: Result
        structure: "Result<T, E>"
        description: "Generic Result type for error handling"
        variants:
          - "{ ok: true; data: T }"
          - "{ ok: false; error: E }"
    
    # パラメータ解析結果型
    params_types:
      - name: ParamsResult
        structure: "ZeroParamsResult | OneParamsResult | TwoParamsResult | ErrorResult"
        description: "Discriminated union for parameter parsing results"
        
      - name: Options
        structure: "TwoParamsResult.Options | OneParamsResult.Options | ZeroParamsResult.Options"
        description: "Union of option types from different parameter results"
    
    # ドメインモデル型
    domain_types:
      - name: ConfigProfileName
        structure: "{ value: string; brand: unique symbol }"
        description: "Value object for configuration profile name"
        
      - name: DirectiveType
        structure: "{ value: string; brand: unique symbol }"
        description: "Processing direction type (to, summary, defect)"
        
      - name: LayerType
        structure: "{ value: string; brand: unique symbol }"
        description: "Hierarchical layer type (project, issue, task)"
        
      - name: TwoParams
        structure: "{ directiveType: DirectiveType; layerType: LayerType }"
        description: "Aggregate root combining directive and layer types"
    
    # プロンプト変数型
    prompt_types:
      - name: PromptVariables
        structure: "StandardVariable | FilePathVariable | StdinVariable | UserVariable"
        description: "Union of all prompt variable types"
        
      - name: PromptPath
        structure: "{ prompt: string; schema?: string }"
        description: "Paths to prompt template and schema files"
    
    # エラー型
    error_types:
      - name: TwoParamsOrchestratorError
        structure: "Discriminated union with 'kind' field"
        kinds:
          - "InvalidParameterCount"
          - "ValidationError"
          - "StdinProcessingError"
          - "VariableProcessingError"
          - "PromptGenerationError"
          - "OutputProcessingError"
          
      - name: ConfigProfileNameError
        structure: "Discriminated union with 'kind' field"
        kinds:
          - "EmptyValue"
          - "InvalidPattern"
          - "TooLong"

  # 距離判定結果
  distance_assessment:
    core_path:
      description: "Two params flow is the core skeleton"
      steps:
        - config_detection
        - config_loading
        - parameter_parsing
        - two_params_validation
        - stdin_processing
        - variable_processing
        - prompt_generation
        - stdout_output
    
    peripheral_paths:
      - zero_params: "Distance: 2 (different purpose - help/version)"
      - one_param: "Distance: 2 (different purpose - initialization)"
      - error_handling: "Distance: 1 (same path but error branch)"
```


## ディレクトリ一覧

```
lib/application/initialization/
lib/application/templates/
lib/breakdown/.obsidian/
lib/breakdown/prompts/
lib/breakdown/schema/find/
lib/breakdown/schema/to/
lib/cli/config/
lib/cli/generators/
lib/cli/handlers/
lib/cli/initialization/
lib/cli/orchestrators/
lib/cli/processors/
lib/cli/validators/
lib/domain/core/
lib/domain/generic/
lib/domain/supporting/
lib/domain/templates/
lib/factory/0_architecture/
lib/infrastructure/templates/
lib/prompt/variables/
lib/types/defaults/
lib/workspace/path/
lib/application/
lib/breakdown/
lib/breakdown/schema/
lib/builder/
lib/cli/
lib/commands/
lib/config/
lib/domain/
lib/factory/
lib/helpers/
lib/infrastructure/
lib/io/
lib/migration/
lib/processor/
lib/prompt/
lib/templates/
lib/types/
lib/validator/
lib/workspace/
lib/
tests/helpers/stdin
tests/helpers
tests/fixtures/schema/to/project
tests/fixtures/schema/to
tests/fixtures/schema/summary
tests/fixtures/schema
tests/fixtures/prompts/to/task
tests/fixtures/prompts/to/project
tests/fixtures/prompts/to/issue
tests/fixtures/prompts/to
tests/fixtures/prompts/summary/task
tests/fixtures/prompts/summary/project
tests/fixtures/prompts/summary
tests/fixtures/prompts
tests/fixtures/config
tests/fixtures
tests/4_cross_domain/collaboration
tests/4_cross_domain
tests/2_generic_domain/templates
tests/2_generic_domain/system/logging
tests/2_generic_domain/system/io
tests/2_generic_domain/system/initialization
tests/2_generic_domain/system/error_handling
tests/2_generic_domain/system/coordination
tests/2_generic_domain/system
tests/2_generic_domain/factory
tests/2_generic_domain
tests/1_supporting_domain
tests/0_core_domain/prompt_variable_generation
tests/0_core_domain/prompt_path_resolution
tests/0_core_domain/parameter_parsing
tests/0_core_domain/domain_collaboration
tests/0_core_domain
tests/
```

# 作業開始指示

まずチームを立ち上げます。
その後、初期タスク（仕様理解、実装調査）を早々にワーカープールマネージャーへ渡します。

続いて、仕様の理解を進め、実装方針に基づいてワーカープールの稼働を最大化します。
その後は、チーム全体のパフォーマンスが重要です。
常にワーカープールマネージャーと、その部下であるゴルーチンをフル稼働させてください。

今なにをすべきか（タスク分割や、状況整理、要件定義、実装、テスト）について、ワーカープールマネージャーが把握していることが重要です。ワーカープールマネージャーから、今やる詳細タスクへ分割し、部下ゴルーチンへ割り当てさせてください。

プロジェクトの成功を祈ります。開始してください。
