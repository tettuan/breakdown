# プロジェクト: Breakdown全体のドメイン駆動設計と全域性（Totality）への移行と処理統一

実装方針:
現在の`lib/`配下の実装をドメイン駆動設計と全域性（Totality）による設計で、処理を統一する。重複実装を削除し、ドメイン領域の明確な理解に基づき、型安全性を強化して、骨格が通った芯の強いコード体系に統一する。

`Totality` について、必ず `docs/breakdown/generic_domain/system/overview/totality.ja.md` を参照すること。
ドメイン情報は、 `docs/breakdown/domain_core/two_params_types.ja.md.ja.md` および `docs/breakdown/domain_core/*` を必ず読むこと。

テスト方針:
テストに関しては `docs/tests/testing.ja.md` を読むこと。

仕様:
他の`docs/breakdown/*`資料は、適宜実装ファイルを変更するタイミングで読むこと。

## 実施内容

1. 資料を読んで、ドメイン設計と Totality を理解する。
2. 理解した結果や調査した結果を `tmp/<branch_name>/` 配下に作成する。
2-1. `two_params_types.ja.md` について入念に理解する
3. 「修正対象」をリストとして扱い、順次処理する。
4. リストに基づき、`@deprecated` な処理は一掃(全面的削除)する。
5. 旧式の実装を削除し、重複処理を削除し、利用していない新方式を取り込む
5-1. 3で作業選択した型と同じフォルダ階層で、他のファイルを調べる
5-2. ファイル内に類似処理があれば、さらに詳しく読み込む
5-3. 既存の実装より適した実装があれば、既存実装を捨てて、新実装へ書き換える
5-4. 「DDD版」や「Simple版」を削除する。（他の版があるため重複実装である）
5-5. メイン処理から順に、3-4回パターン別で処理をトレースし、呼び出されることのないコードならば、ファイルごと削除する
6. 削除した実装のテストは、連動して削除する
7. 3で作成したリストの全てが完了するまで、再び4に戻り、実装修正を行う

**テストは実施せず、実装コード修正に集中する**

### 全ての「実施内容」が完了した後

1. 「ディレクトリ一覧」を１行ずつ選び、ディレクトリ内のファイルを順序よく調べる
2. 個々のファイルを開き、重複処理の存在をチェックする
3. 重複処理があったら `tmp/duplicated_files.md` へ書き出す
4. 重複処理の実装ファイルは削除する
5. 1の処理へ戻る

## 完了条件

1. 重複処理が削除された
2. `tmp/duplicated_files.md`が完成した


# タスクの進め方

- Git:
  - 現在のGitブランチで作業する
- サイクル: 仕様把握 → 調査 → 計画・設計 → 実行 → 記録・検証 → 学習 → 仕様把握へ戻る
- 作業分担: 作業内容をワーカープールマネージャーへ依頼し、ワーカーへの指示を行わせる。チームの常時フル稼働を目指す。

## チームの構成

あなたは指揮官であり上司である。
最初にチームを立ち上げて進める。

`instructions/team-head.ja.md` に詳細の記載がある。
チーム立ち上げの指示なので、必ず最初に読むこと。
各paneの存在を確認し、無ければ起動し、あればClaudeの起動を確認すること。全員を調べ、Claudeが起動していない部下に対し,Claude起動する。


## 進捗更新

- 進捗させるべきタスクは `tmp/<branch_name>/tasks.md` に書き出し、完了マークをつけたりしながら進めてください。
- すべてが完了したら、`tmp/<branch_name>/completed.md` に完了したレポートを記録してください。


## 修正対象
``````
# Breakdown アプリケーション骨格YAML - 2025-07-12

## 実行パターン分析結果

### 初期引数パターン
- zero: `breakdown --version`
- one: `breakdown init`  
- two: `breakdown to project`, `breakdown summary project`, `breakdown defect task`

### 骨格判定結果
**骨格の中心**: `runBreakdown` → パラメータ解析 → `handleTwoParams` → プロンプト生成 → 標準出力
**共通経路**: 全パターンが通るConfigPrefixDetector, ParamsParser

## アプリケーション構造

### 第1階層: メインエントリーポイント
main_entry_point:
  - name: runBreakdown
    initializer: runBreakdown()
    args: args: string[]
    return: Result<void, BreakdownError>
    flow:
      - config_detection: ConfigPrefixDetector.detect()
      - config_loading: ConfigLoader.loadBreakdownConfig()
      - params_parsing: ParamsParser.parse()
      - handler_delegation: handleZeroParams | handleOneParams | handleTwoParams

### 第2階層: パラメータハンドリング（分岐点）
parameter_handlers:
  zero_params:
    - name: handleZeroParams
      initializer: handleZeroParams()
      args: args: string[], config: Record<string, unknown>, options: Record<string, unknown>
      return: void
      flow:
        - help_display: showHelp() | showVersion() | showUsage()
  
  one_params:
    - name: handleOneParams
      initializer: handleOneParams()
      args: params: string[], config: Record<string, unknown>, options: Record<string, unknown>
      return: Promise<void>
      flow:
        - command_routing: initializeBreakdownConfiguration()
  
  two_params:
    - name: handleTwoParams
      initializer: handleTwoParams()
      args: params: string[], config: Record<string, unknown>, options: Record<string, unknown>
      return: Promise<Result<void, TwoParamsHandlerError>>
      flow:
        - orchestration: TwoParamsOrchestrator.execute()

### 第3階層: コア処理（プロンプト生成の心臓部）
core_processing:
  orchestrator:
    - name: TwoParamsOrchestrator
      initializer: new TwoParamsOrchestrator()
      args: outputProcessor?: TwoParamsOutputProcessor
      return: TwoParamsOrchestrator
      flow:
        - validation: TwoParamsValidator.validate()
        - stdin_processing: TwoParamsStdinProcessor.process()
        - variable_processing: TwoParamsVariableProcessor.processVariables()
        - prompt_generation: TwoParamsPromptGenerator.generatePrompt()
        - output_processing: TwoParamsOutputProcessor.writeOutput()

  prompt_generator:
    - name: TwoParamsPromptGenerator
      initializer: new TwoParamsPromptGenerator()
      args: adapter?: PromptManagerAdapter
      return: TwoParamsPromptGenerator
      flow:
        - config_creation: createConfiguration()
        - context_creation: createGenerationContext()
        - factory_creation: PromptVariablesFactory.createWithConfig()
        - variables_building: VariablesBuilder.build()
        - prompt_content_generation: PromptManagerAdapter.generatePrompt()

  factory_system:
    - name: PromptVariablesFactory
      initializer: PromptVariablesFactory.createWithConfig()
      args: config: Record<string, unknown>, params: PromptCliParams
      return: Result<PromptVariablesFactory, FactoryCreationError>
      flow:
        - validation: validateAll()
        - param_extraction: getAllParams()

## JSRパッケージ統合

external_packages:
  breakdownconfig:
    - name: ConfigLoader
      initializer: ConfigLoader.loadBreakdownConfig()
      args: profileName: string, workingDir: string
      return: Result<Record<string, unknown>, ConfigError>
  
  breakdownparams:
    - name: ParamsParser
      initializer: new ParamsParser()
      args: undefined, customConfig?: CustomConfig
      return: ParamsParser
      flow:
        - parsing: parse()
        - result_types: ZeroParamsResult | OneParamsResult | TwoParamsResult | ErrorResult
  
  breakdownprompt:
    - name: PromptManagerAdapter
      initializer: new PromptManagerAdapter()
      args: none
      return: PromptManagerAdapter
      flow:
        - generation: generatePrompt()

## 型システム骨格

core_types:
  result_types:
    - name: Result
      structure: Result<T, E>
      description: "Generic Result type for error handling"
      
    - name: ParamsResult
      structure: ZeroParamsResult | OneParamsResult | TwoParamsResult | ErrorResult
      description: "Discriminated union for parameter parsing results"

  domain_types:
    - name: TwoParamsHandlerError
      structure: "InvalidParameterCount | InvalidDemonstrativeType | InvalidLayerType | StdinReadError | FactoryCreationError | FactoryValidationError | VariablesBuilderError | PromptGenerationError | OutputWriteError"
      description: "Complete error types for two params processing"
      
    - name: PromptGeneratorError
      structure: "FactoryCreationError | FactoryValidationError | VariablesBuilderError | PromptPathError | PromptGenerationError | TemplateError | InvalidConfiguration | ConfigurationValidationError | InvalidContext"
      description: "Exhaustive prompt generation error types"

  value_objects:
    - name: ValidatedParams
      structure: "{ readonly demonstrativeType: string, readonly layerType: string }"
      description: "Validated parameters from upstream validator"
      
    - name: ProcessedVariables
      structure: "{ standardVariables: Record<string, string>, customVariables: Record<string, string> }"
      description: "Variables processed for prompt generation"
      
    - name: PromptConfiguration
      structure: "{ readonly promptDir?: string, readonly schemaDir?: string, readonly workingDir?: string, readonly adaptation?: string, readonly extended?: boolean, readonly customValidation?: boolean, readonly errorFormat?: string }"
      description: "Immutable configuration for prompt generation"

## エラーハンドリング戦略

error_flow:
  totality_principle:
    - description: "All functions are total (no exceptions, undefined returns)"
    - implementation: "Result types for all operations that can fail"
    - exhaustive_checking: "Discriminated unions for error types"
  
  error_propagation:
    - config_errors: "ConfigProfileError → BreakdownError"
    - validation_errors: "TwoParamsHandlerError → BreakdownError"
    - prompt_errors: "PromptGeneratorError → TwoParamsHandlerError"
  
  error_handling_points:
    - entry_point: "runBreakdown catches all BreakdownError types"
    - orchestrator: "TwoParamsOrchestrator maps all component errors"
    - generator: "TwoParamsPromptGenerator handles all prompt generation errors"

## データフロー

data_transformation:
  input_flow:
    - cli_args: "string[] → ParamsResult"
    - config_detection: "string[] → ConfigProfileName"
    - config_loading: "ConfigProfileName → BreakdownConfig"
    - stdin_processing: "STDIN → ProcessedVariables.standardVariables.input_text"
  
  processing_flow:
    - validation: "string[] → ValidatedParams"
    - variable_processing: "options + stdin → ProcessedVariables"
    - factory_creation: "config + PromptCliParams → PromptVariablesFactory"
    - prompt_generation: "PromptPath + PromptVariables → string"
  
  output_flow:
    - prompt_content: "string → stdout (標準出力)"
    - error_messages: "BreakdownError → stderr"

## 距離判定による階層配置根拠

skeleton_distance_analysis:
  center_axis:
    description: "runBreakdown → handleTwoParams → TwoParamsPromptGenerator.generatePrompt"
    
  layer_1_distance: 
    horizontal: 0
    vertical: 1
    components: ["runBreakdown", "ConfigPrefixDetector", "ParamsParser"]
    reasoning: "メインフローの開始点、全パターン共通"
    
  layer_2_distance:
    horizontal: 1
    vertical: 2-3
    components: ["handleZeroParams", "handleOneParams", "handleTwoParams", "TwoParamsOrchestrator"]
    reasoning: "パラメータパターンによる分岐、異なる処理意図"
    
  layer_3_distance:
    horizontal: 1-2
    vertical: 3-5
    components: ["TwoParamsPromptGenerator", "PromptVariablesFactory", "VariablesBuilder", "PromptManagerAdapter"]
    reasoning: "プロンプト生成のコア処理、最も複雑な内部処理"

## 簡易な宣言構造

simplified_declarations:
  primary_unions:
    - ParamsResult: "ZeroParamsResult | OneParamsResult | TwoParamsResult | ErrorResult"
    - BreakdownError: "ConfigProfileError | ConfigLoadError | ParameterParsingError | TwoParamsHandlerError | OneParamsHandlerError | ZeroParamsHandlerError | UnknownResultType"
    - TwoParamsHandlerError: "InvalidParameterCount | InvalidDemonstrativeType | InvalidLayerType | StdinReadError | FactoryCreationError | FactoryValidationError | VariablesBuilderError | PromptGenerationError | OutputWriteError"
  
  key_interfaces:
    - Result: "{ ok: true; data: T } | { ok: false; error: E }"
    - ValidatedParams: "{ readonly demonstrativeType: string; readonly layerType: string }"
    - ProcessedVariables: "{ standardVariables: Record<string, string>; customVariables: Record<string, string> }"
    - PromptConfiguration: "{ readonly promptDir?: string; readonly schemaDir?: string; [other_configs] }"
  
  factory_types:
    - PromptVariablesFactory: "Config + PromptCliParams → Validated Factory Instance"
    - VariablesBuilder: "FactoryResolvedValues → Record<string, string>"
    - PromptManagerAdapter: "PromptPath + PromptVariables → Generated Prompt Content"

## ゴール地点までの最短経路

shortest_path_to_goal:
  normal_flow:
    1: "runBreakdown(args)"
    2: "ParamsParser.parse(args) → TwoParamsResult"
    3: "handleTwoParams(params, config, options)"
    4: "TwoParamsOrchestrator.execute()"
    5: "TwoParamsPromptGenerator.generatePrompt()"
    6: "PromptManagerAdapter.generatePrompt() → prompt content"
    7: "console.log(content) → 標準出力"
  
  critical_success_factors:
    - configuration_loading: "設定ファイルまたはデフォルト設定の確実な読み込み"
    - parameter_validation: "demonstrativeType と layerType の正確な検証"
    - prompt_path_resolution: "適切なプロンプトテンプレートファイルの特定"
    - variable_substitution: "テンプレート内変数の正確な置換"
    - output_delivery: "生成されたプロンプトの標準出力への確実な出力"

## 異常系経路

error_paths:
  config_errors:
    - trigger: "設定ファイル不在、無効な設定"
    - handling: "警告出力 + デフォルト設定で継続"
    
  validation_errors:
    - trigger: "無効なparameter, 型不一致"
    - handling: "エラーメッセージ出力 + 処理停止"
    
  template_errors:
    - trigger: "プロンプトテンプレートファイル不在"
    - handling: "PromptPathError + 処理停止"
    
  variable_errors:
    - trigger: "変数置換失敗、スキーマ不整合"
    - handling: "VariablesBuilderError + 処理停止"

---
# メタデータ
generated_date: "2025-07-12"
analysis_scope: "Breakdown main execution flow and core type system"
analysis_method: "Static code analysis + DDD architecture pattern identification"
skeleton_criteria: "Execution frequency + Distance from main flow + Type safety importance"
``````


## ディレクトリ一覧

```
lib/application
lib/application/services
lib/application/templates
lib/breakdown
lib/breakdown/schema
lib/breakdown/schema/find
lib/breakdown/schema/find/bugs
lib/breakdown/schema/to
lib/breakdown/schema/to/issue
lib/breakdown/schema/to/project
lib/breakdown/schema/to/task
lib/builder
lib/cli
lib/cli/config
lib/cli/generators
lib/cli/handlers
lib/cli/initialization
lib/cli/processors
lib/cli/validators
lib/commands
lib/config
lib/domain
lib/domain/core
lib/domain/core/aggregates
lib/domain/core/value_objects
lib/domain/errors
lib/domain/generic
lib/domain/generic/template_management
lib/domain/generic/template_management/value_objects
lib/domain/supporting
lib/domain/templates
lib/factory
lib/factory/0_architecture
lib/helpers
lib/infrastructure
lib/infrastructure/templates
lib/io
lib/migration
lib/processor
lib/prompt
lib/prompt/variables
lib/supporting
lib/supporting/initialization
lib/templates
lib/types
lib/types/defaults
lib/validator
lib/workspace
lib/workspace/path
tests/0_core_domain
tests/0_core_domain/domain_collaboration
tests/0_core_domain/parameter_parsing
tests/0_core_domain/prompt_path_resolution
tests/0_core_domain/prompt_variable_generation
tests/1_supporting_domain
tests/2_generic_domain
tests/2_generic_domain/factory
tests/2_generic_domain/system
tests/2_generic_domain/system/coordination
tests/2_generic_domain/system/error_handling
tests/2_generic_domain/system/initialization
tests/2_generic_domain/system/io
tests/2_generic_domain/system/logging
tests/2_generic_domain/templates
tests/4_cross_domain
tests/4_cross_domain/collaboration
tests/4_cross_domain/e2e
tests/fixtures
tests/fixtures/config
tests/fixtures/prompts
tests/fixtures/prompts/summary
tests/fixtures/prompts/summary/project
tests/fixtures/prompts/summary/task
tests/fixtures/prompts/to
tests/fixtures/prompts/to/issue
tests/fixtures/prompts/to/project
tests/fixtures/prompts/to/task
tests/fixtures/schema
tests/fixtures/schema/summary
tests/fixtures/schema/to
tests/fixtures/schema/to/project
tests/helpers
tests/helpers/stdin
tests/integration
tests/integration/directive_layer_types
tests/integration/directive_layer_types/fixtures
tests/integration/directive_layer_types/fixtures/configs
tests/integration/directive_layer_types/fixtures/inputs
tests/integration/directive_layer_types/fixtures/prompts
tests/integration/directive_layer_types/fixtures/schemas
tests/integration/directive_layer_types/test_scenarios
tests/integration/directive_layer_types/tests
```

# 作業開始指示

まずチームを立ち上げます。
その後、初期タスク（仕様理解、実装調査）を早々にワーカープールマネージャーへ渡します。

続いて、仕様の理解を進め、実装方針に基づいてワーカープールの稼働を最大化します。
その後は、チーム全体のパフォーマンスが重要です。
常にワーカープールマネージャーと、その部下であるゴルーチンをフル稼働させてください。

今なにをすべきか（タスク分割や、状況整理、要件定義、実装、テスト）について、ワーカープールマネージャーが把握していることが重要です。ワーカープールマネージャーから、今やる詳細タスクへ分割し、部下ゴルーチンへ割り当てさせてください。

プロジェクトの成功を祈ります。開始してください。
