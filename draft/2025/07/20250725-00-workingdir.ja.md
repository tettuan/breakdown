# 緊急修正指示書 - WorkspaceとWorkingDirのパス解決問題の修正

## 実装方針

プロジェクトルートにテンプレートパスを必要とするエラーを修正し、(1)workspaeceとworking_dirの一元化を指示する。(2)パス決定ドメインの責務を明確にしながら、設定を用いた作業ディレクトリの問題を解決する。(3)PATH構成文字のハードコーディングを廃止しENUM化および一元化する。設定値を用いるべき場所を、変数・定数名で明確化する。

作業着手前に、設計思想を理解する。
`Totality` について、必ず `docs/breakdown/generic_domain/system/overview/totality.ja.md` を参照すること。
ドメイン情報は、 `docs/breakdown/domain_core/domain_boundaries_flow.ja.md` および `docs/breakdown/domain_core/*` を必ず読むこと。
実装のAI複雑性制御は `docs/breakdown/domain_core/ai-complexity-control_compact.ja.md` の原則に従い、最小限の修正で最大の効果を得ること。


テスト方針:
テストに関しては `docs/tests/testing.ja.md` を読むこと。

仕様:
他の`docs/breakdown/*`資料は、適宜実装ファイルを変更するタイミングで読むこと。

### 問題の背景

examples/実行結果より、以下の問題が確認された：
1. 全スクリプトは成功したが、プロジェクトルート直下へプロンプトテンプレートが生成された
2. プロジェクトルート直下へプロンプトテンプレートが生成されないと、プロンプトが認識されない。
3. 実際に他プロジェクトで最新版利用したが、`app_prompt.base_dir`が無視されている。
3. 相対パス解決が設定と不整合

[TwoParams型システム](docs/breakdown/domain_core/two_params_types.ja.md)の設計に従い、DirectiveTypeとLayerTypeの組み合わせによるパス解決を正しく機能させる必要がある。


## チームの構成

あなたは指揮官であり上司である。
最初にチームを立ち上げて進める。

`instructions/team-head.ja.md` に詳細の記載がある。
チーム立ち上げの指示なので、必ず最初に読むこと。
各paneの存在を確認し、無ければ起動し、あればClaudeの起動を確認すること。全員を調べ、Claudeが起動していない部下に対し,Claude起動する。


## 実施内容

### 1. 前提理解
1. 資料を読んで、ドメイン設計と Totality を理解する。
2. 理解した結果や調査した結果を `tmp/<branch_name>/` 配下に作成する。

### 2. 作業開始
3. 「修正内容の詳細」を修正する
4. 以下のチェックコマンドを順次行い、成功か失敗かで次のステップを変える。
4-1. `deno check [DIR]` : 成功→6-2,失敗→7
4-2. `deno test [DIR]` : 成功→6-3,失敗→7
4-3. `deno lint [DIR]` : 成功→6-4,失敗→7
4-4. `deno fmt [DIR]`  : 成功→8,失敗→7
5. エラー修正作業をワーカープールに割り当て、修正後に6のステップを再確認させる
6. `deno task ci:dirty` を実行。エラー → 「2. 作業開始」を最初から実施


#### 修正内容の詳細

`````
# 🛠️ Breakdown CLI修正計画概要

## プロジェクト情報
- **作成日**: 2025-07-24
- **基準ブランチ**: fix-working-dir-path-resolution
- **現在の品質評価**: 9.0/10.0
- **目標品質評価**: 9.5+/10.0

## 🚨 Phase 1: 緊急修正（最優先・即座実施）

### 1.1 schemas/パスハードコーディング修正
**対象**: `lib/factory/prompt_variables_factory.ts` (行691, 702, 988, 993)
**重要度**: 🔴 最高優先度

```typescript
// 修正前（問題のあるハードコーディング）
return `schemas/${this.cliParams.directiveType}/${this.cliParams.layerType}/f_${this.cliParams.layerType}.json`;

// 修正後（設定ベース）
const schemaBaseDir = this.config.app_schema.base_dir;
return `${schemaBaseDir}/${this.cliParams.directiveType}/${this.cliParams.layerType}/f_${this.cliParams.layerType}.json`;
```

**影響範囲**: スキーマファイル解決の全処理
**検証方法**: カスタムworking_dir環境でのテスト実行

### 1.2 初期化サービス修正
**対象**: `lib/supporting/initialization/init_service.ts` (行136, 138, 145, 147)
**重要度**: 🔴 高優先度

```typescript
// 修正前（固定パス文字列）
mkdir -p prompts/${directive}
mkdir -p prompts/${directive}/${layer}
mkdir -p schemas/${directive}
mkdir -p schemas/${directive}/${layer}

// 修正後（設定ベース）
const promptBaseDir = config.app_prompt.base_dir;
const schemaBaseDir = config.app_schema.base_dir;
mkdir -p ${promptBaseDir}/${directive}
mkdir -p ${promptBaseDir}/${directive}/${layer}
mkdir -p ${schemaBaseDir}/${directive}
mkdir -p ${schemaBaseDir}/${directive}/${layer}
```

**影響範囲**: プロジェクト初期化処理
**検証方法**: `breakdown init`コマンドの動作確認

### 1.3 Examples修正（即座実施可能）
**対象**: STDIN問題のあるスクリプト
**重要度**: 🟡 中優先度

#### STDIN入力問題修正
**対象ファイル**: 
- `examples/04_stdin_example.sh`
- `examples/09_config_environments.sh`

```bash
# 修正前（STDIN使用）
echo "content" | breakdown summary project

# 修正後（--fromオプション使用）
echo "content" > temp_input.md
breakdown summary project --from=temp_input.md
rm temp_input.md
```

#### ハング問題修正
**対象ファイル**: `examples/06_config_basic.sh`

```bash
# 問題箇所: テンプレートコピー処理の無限ループ
# 修正: タイムアウト機能追加またはコピー処理の見直し
```

**影響範囲**: Examples実行成功率 89.5% → 100%目標
**検証方法**: 全Examplesスクリプトの順次実行確認

---

## ⚡ Phase 2: 設定一元化（短期実施・1-2week）

### 2.1 .agent/breakdownハードコーディング除去
**重要度**: 🟠 中優先度

#### 対象箇所
- `lib/config/constants.ts:6` - `root: ".agent/breakdown"`
- `lib/factory/schema_file_path_resolver_totality.ts:25` - `DEFAULT_SCHEMA_BASE_DIR`
- `lib/workspace/path/default_path_strategy.ts:56` - `workspaceDir = ".agent/breakdown"`
- `lib/workspace/path/strategies.ts:407` - `constructor(baseDir: string = ".agent/breakdown")`

#### 修正方針
```typescript
// constants.tsを設定ファイル読み込みベースに変更
export const getDefaultRoot = (config?: BreakdownConfig): string => {
  return config?.workspace?.working_dir || 
         config?.working_dir || 
         ".agent/breakdown";
};

// デフォルト値の動的取得
const DEFAULT_ROOT = getDefaultRoot(loadedConfig);
const DEFAULT_CONFIG_DIR = `${DEFAULT_ROOT}/config`;
const DEFAULT_SCHEMA_BASE_DIR = `${DEFAULT_ROOT}/schema`;
```

**影響範囲**: デフォルト値参照の全箇所
**検証方法**: 環境変数による設定上書きテスト

### 2.2 working_dir設定重複解消
**重要度**: 🟠 高優先度

#### 問題: 4つの重複する設定項目
1. `config.working_dir` （アプリケーション設定）
2. `config.workspace.working_dir` （ワークスペース設定）
3. `--working-dir` （CLI引数）
4. `Deno.cwd()` （ランタイムフォールバック）

#### 統一方針
```typescript
// 単一の優先度階層に統合
const resolveWorkingDir = (
  cliArgs: CLIArgs, 
  config: BreakdownConfig
): string => {
  return cliArgs.workingDir ||           // 最高優先度（CLI引数）
         config.working_dir ||           // 中優先度（設定ファイル）
         Deno.cwd();                     // 最低優先度（フォールバック）
}

// workspace.working_dirは廃止予定
// 移行期間中は警告メッセージを表示
```

#### 影響を受けるファイル
- `lib/factory/prompt_template_path_resolver_totality.ts:191-192`
- `lib/config/factory_integration.ts:285`
- `lib/config/unified_config_interface.ts` (複数箇所)

**影響範囲**: working_dir解決の全処理
**検証方法**: 設定階層の動作テスト

---

## 🔧 Phase 3: パス解決統一化（中期実施・1month）

### 3.1 統一パス解決サービス作成
**重要度**: 🟢 中優先度

#### 新規作成: `lib/services/unified_path_resolver.ts`
```typescript
export class UnifiedPathResolver {
  constructor(private config: BreakdownConfig) {}
  
  resolvePromptPath(directive: string, layer: string): string {
    const baseDir = this.config.app_prompt.base_dir;
    const workingDir = this.config.working_dir;
    
    if (isAbsolute(baseDir)) {
      return resolve(baseDir, directive, layer, `f_${layer}.md`);
    } else {
      return resolve(workingDir, baseDir, directive, layer, `f_${layer}.md`);
    }
  }
  
  resolveSchemaPath(directive: string, layer: string): string {
    const baseDir = this.config.app_schema.base_dir;
    const workingDir = this.config.working_dir;
    
    if (isAbsolute(baseDir)) {
      return resolve(baseDir, directive, layer, `f_${layer}.json`);
    } else {
      return resolve(workingDir, baseDir, directive, layer, `f_${layer}.json`);
    }
  }
  
  resolveOutputPath(outputOption?: string): string {
    if (!outputOption) {
      return this.generateAutoFilename();
    }
    
    if (isAbsolute(outputOption)) {
      return outputOption;
    } else {
      return resolve(this.config.working_dir, outputOption);
    }
  }
  
  private generateAutoFilename(): string {
    const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, '');
    const hash = this.generateRandomHash();
    return resolve(this.config.working_dir, `${timestamp}_${hash}.md`);
  }
}
```

#### 既存ファイルの移行
- `lib/factory/prompt_template_path_resolver_totality.ts` → UnifiedPathResolverを使用
- `lib/factory/schema_file_path_resolver_totality.ts` → UnifiedPathResolverを使用
- `lib/factory/input_file_path_resolver_totality.ts` → UnifiedPathResolverを使用

**影響範囲**: パス解決処理の全箇所
**検証方法**: 既存テストの全パス + 新規統合テスト

### 3.2 相対パス処理改善
**重要度**: 🟢 中優先度

#### 問題: `Deno.cwd()`への環境依存フォールバック
現在の問題点:
```typescript
// 環境依存の問題のあるコード
const workingDir = this.config.working_dir || Deno.cwd();
```

#### 修正方針
```typescript
// 設定ファイル中心の絶対パス解決
const resolveAbsolutePath = (basePath: string, workingDir: string): string => {
  if (isAbsolute(basePath)) {
    return basePath;
  }
  
  // working_dirも相対パスの場合は、プロジェクトルートベースで解決
  const resolvedWorkingDir = isAbsolute(workingDir) 
    ? workingDir 
    : resolve(findProjectRoot() || Deno.cwd(), workingDir);
    
  return resolve(resolvedWorkingDir, basePath);
};

// プロジェクトルート検出機能
const findProjectRoot = (): string | null => {
  let currentDir = Deno.cwd();
  while (currentDir !== dirname(currentDir)) {
    if (existsSync(join(currentDir, 'deno.json')) || existsSync(join(currentDir, '.git'))) {
      return currentDir;
    }
    currentDir = dirname(currentDir);
  }
  return null;
};
```

**影響範囲**: 相対パス解決の全処理
**検証方法**: Docker/CI環境での一貫性テスト

### 3.3 型安全性向上
**重要度**: 🟢 低優先度

#### 対象: `PromptResolverConfig`型の重複除去
```typescript
// 修正前（3つの重複定義）
export type PromptResolverConfig = 
  | { kind: "WithPromptConfig"; working_dir?: string; }
  | { kind: "WithSchemaConfig"; working_dir?: string; }
  | { kind: "NoConfig"; working_dir?: string; }

// 修正後（統一定義）
export type UnifiedPathResolverConfig = {
  working_dir: string;  // 必須化（デフォルト値で保証）
  app_prompt: { 
    base_dir: string; 
  };
  app_schema: { 
    base_dir: string; 
  };
}

// Smart Constructorパターンで型安全な生成
export const createPathResolverConfig = (
  config: BreakdownConfig
): UnifiedPathResolverConfig => {
  return {
    working_dir: config.working_dir || Deno.cwd(),
    app_prompt: {
      base_dir: config.app_prompt?.base_dir || "prompts"
    },
    app_schema: {
      base_dir: config.app_schema?.base_dir || "schemas"
    }
  };
};
```

**影響範囲**: 型定義とファクトリー層
**検証方法**: TypeScript型チェック + 単体テスト

---

## 📅 実装タイムライン

| Phase | 期間 | 主要作業 | 影響範囲 | 検証方法 |
|-------|------|----------|----------|----------|
| **Phase 1** | 即座～3日 | ハードコーディング修正、Examples修正 | 高（緊急） | Examples全実行、カスタム環境テスト |
| **Phase 2** | 1-2週間 | 設定重複解消、デフォルト値動的化 | 中（設計改善） | 設定階層テスト、環境変数テスト |
| **Phase 3** | 1ヶ月 | パス解決統一化、型安全性向上 | 低（アーキテクチャ） | 統合テスト、Docker/CI環境テスト |

## 🎯 期待効果

### Phase 1完了後
- ✅ working_dir設定が正常に反映される
- ✅ schemas/パスが設定通りに解決される  
- ✅ Examples STDIN問題が解決される
- ✅ Examples成功率: 89.5% → 100%

### Phase 2完了後
- ✅ 設定の一貫性が保たれる
- ✅ .agent/breakdownへの依存が解消される
- ✅ 環境設定の柔軟性が向上する
- ✅ working_dir重複問題が解決される

### Phase 3完了後
- ✅ パス解決処理が統一される
- ✅ 型安全性が向上する
- ✅ Docker/CI環境での安定性が保証される
- ✅ 保守性とテスタビリティが向上する

## ✅ 修正検証方法

### 各Phase共通の検証
```bash
# 基本動作確認
1. examples/全スクリプト実行 → 100%成功目標
2. deno task ci → 全ステージ成功維持
3. 既存テストスイート → 全テストパス維持

# Phase固有の検証
Phase 1: カスタムworking_dir環境でのテスト
Phase 2: 環境変数・設定階層の動作確認  
Phase 3: Docker環境・統合テストでの安定性確認
```

### パフォーマンス検証
```bash
# 修正前後のベンチマーク
- パス解決処理の実行時間測定
- メモリ使用量の比較
- 大量ファイル処理での性能確認
```

### 互換性検証
```bash
# 既存プロジェクトでの動作確認
- 既存の設定ファイルとの互換性
- 既存のワークフローとの整合性
- 既存のスクリプトとの連携確認
```

## 🎖️ 品質目標

### 修正前（現状）
- **総合品質評価**: 9.0/10.0
- **Examples成功率**: 89.5% (17/19)
- **主要問題**: working_dir設定無視、STDIN変数置換

### 修正後（目標）
- **総合品質評価**: 9.5+/10.0
- **Examples成功率**: 100% (19/19)
- **改善点**: 設定ベースの一貫したパス解決、型安全性向上

## 📋 実装チェックリスト

### Phase 1 チェックリスト
- [ ] `lib/factory/prompt_variables_factory.ts`のschemas/パス修正
- [ ] `lib/supporting/initialization/init_service.ts`の設定ベース化
- [ ] `examples/04_stdin_example.sh`のSTDIN問題修正
- [ ] `examples/06_config_basic.sh`のハング問題修正
- [ ] `examples/09_config_environments.sh`のSTDIN問題修正
- [ ] カスタムworking_dir環境でのテスト実行
- [ ] Examples全スクリプト実行確認

### Phase 2 チェックリスト
- [ ] `lib/config/constants.ts`の動的デフォルト値化
- [ ] working_dir設定重複の解消
- [ ] workspace.working_dirの廃止準備
- [ ] 設定階層の統一化
- [ ] 環境変数による設定上書きテスト
- [ ] 既存設定ファイルとの互換性確認

### Phase 3 チェックリスト
- [ ] `lib/services/unified_path_resolver.ts`の新規作成
- [ ] 既存パス解決処理の移行
- [ ] 相対パス処理の改善
- [ ] 型定義の統合と安全性向上
- [ ] Docker/CI環境での動作確認
- [ ] 統合テストスイートの実行

---

**修正計画作成日**: 2025-07-24  
**作成者**: Claude Code (総司令官)  
**協力者**: Manager1(特別功労), Manager2, Secretary, Worker9名  
**品質目標**: 9.0/10.0 → 9.5+/10.0
`````

#### 完了条件

1. working_dir設定が一元化された
2. ハードコーディングが亡くなった
3. PATH決定のテストが成功した
4. [実装のAI複雑性制御](`docs/breakdown/domain_core/ai-complexity-control_compact.ja.md`) の原則に従い、最小限のコード量で最大の効果を得ること。
5. `deno task ci:dirty` が完全に通過した: エラー0件達成


# タスクの進め方

- Git:
  - 現在のGitブランチで作業する
- サイクル: 仕様把握 → 調査 → 計画・設計 → 実行 → 記録・検証 → 学習 → 仕様把握へ戻る
- 作業分担: 作業内容をワーカープールマネージャーへ依頼し、ワーカーへの指示を行わせる。チームの常時フル稼働を目指す。

## 進捗更新

- 進捗させるべきタスクは `tmp/<branch_name>/tasks.md` に書き出し、完了マークをつけたりしながら進めてください。
- すべてが完了したら、`tmp/<branch_name>/completed.md` に完了したレポートを記録してください。


# 作業開始指示

まずチームを立ち上げます。
その後、初期タスク（仕様理解、実装調査）を早々にワーカープールマネージャーへ渡します。

続いて、仕様の理解を進め、実装方針に基づいてワーカープールの稼働を最大化します。
その後は、チーム全体のパフォーマンスが重要です。
常にワーカープールマネージャーと、その部下であるゴルーチンをフル稼働させてください。

今なにをすべきか（タスク分割や、状況整理、要件定義、実装、テスト）について、ワーカープールマネージャーが把握していることが重要です。ワーカープールマネージャーから、今やる詳細タスクへ分割し、部下ゴルーチンへ割り当てさせてください。

プロジェクトの成功を祈ります。開始してください。



